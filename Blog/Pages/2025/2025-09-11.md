---
title: このブログ（Blazor WebAssembly）のfavicon.icoを直接ブラウザ上で表示するとエラーが発生する現象
url: /20250911
categories: .NET, Blazor, Blog, 小ネタ
$namespace: Blog.Pages
$inherit: PostComponent
---

今回は小ネタ枠になります。  
このブログ自体が、私の`Blazor WebAssembly`関連のテスト環境（~~遊び場~~）のため、試験的な機能導入や設定変更を行うことがあります。（まあいうほど何かしたというわけではないですが...）
その中でちょっと前から気にしていた現象を一応解決？したので、備忘録として記事にしておきます。

## ブラウザでfavicon.icoへアクセスするとエラーが発生する

favicon.icoは、ブラウザタブ等に表示するアイコン画像になります。
このブログだと、[/wwwroot/index.html](https://github.com/prozolic/Blog/blob/main/Blog/wwwroot/index.html)の`<head>`タグ内で指定しています。
URLだと[https://prozolic.blog/favicon.ico](https://prozolic.blog/favicon.ico)でアクセスできます。
特にそこまで気にするものでもないですが、先日ふと直接ブラウザ上で[https://prozolic.blog/favicon.ico](https://prozolic.blog/favicon.ico)へアクセスしてみたところ、以下のようなエラーが発生しました。

```javascript
blazor.webassembly.js:1 crit: Microsoft.AspNetCore.Components.WebAssembly.Rendering.WebAssemblyRenderer[100]
Unhandled exception rendering component: Arg_IndexOutOfRangeException
System.IndexOutOfRangeException: Arg_IndexOutOfRangeException at Microsoft.AspNetCore.Components.ComponentBase.RunInitAndSetParametersAsync(favicon.ico)
```

この状態でブラウザの更新ボタンを押下するとアイコンが表示され、強制リフレッシュ(スーパーリロード)を行うと再度エラーが発生するというちょっと不思議な挙動でした。
ブログにそこまで影響を与えるものではないですが、勉強のため調べておこうということで、ひとまず公式の[ASP.NET Core Blazor Progressive Web Application (PWA)](https://learn.microsoft.com/en-us/aspnet/core/blazor/progressive-web-app/?view=aspnetcore-9.0&tabs=visual-studio)に何か情報がないかと調べていたところ、「要求の解決方法」に以下の内容が記載されていました。

```markdown
「キャッシュ優先のフェッチ戦略」セクションで説明したように、既定のサービス ワーカーでは "キャッシュ優先" 戦略が使用されます。
これは、キャッシュされたコンテンツがあればそれが提供されることを意味します。
特定の URL に対してキャッシュされたコンテンツがない場合 (バックエンド API からデータを要求する場合など)、
サービス ワーカーは通常のネットワーク要求にフォールバックします。
サーバーに到達可能な場合は、ネットワーク要求は成功します。
このロジックは、onFetch 内の service-worker.published.js 関数内に実装されています。
```

service-worker.published.jsのonFetchメソッドにリクエスト時の挙動が記載されていそうなので、まず確認。

```javascript
// service-worker.published.js

async function onFetch(event) {
    let cachedResponse = null;
    if (event.request.method === 'GET') {
        // For all navigation requests, try to serve index.html from cache,
        // unless that request is for an offline resource.
        // If you need some URLs to be server-rendered, edit the following check to exclude those URLs
        const shouldServeIndexHtml = event.request.mode === 'navigate'
            && !manifestUrlList.some(url => url === event.request.url);

        const request = shouldServeIndexHtml ? 'index.html' : event.request;
        const cache = await caches.open(cacheName);
        cachedResponse = await cache.match(request);
    }

    return cachedResponse || fetch(event.request);
}
```

Blazor WebAssemblyのプロジェクト作成時に生成されていたものをそのまま使用していました。
コードはざっくりとですが、`event.request.method`が`GET`の場合に、リクエストのURLがナビゲーションかどうか判定し、キャッシュから取得する、もしくはキャッシュが存在しない場合はネットワークから取得するというものでした。（間違っていたらすみません。）
そこまで問題があるコードにも見えなかったため、実際にブラウザ上でどういう処理を行っているか確認していたところ、

![20250911_service-worker.published.js](./post_images/20250911_service-worker.published.js.png)

...manifestUrlListに格納されているfavicon.icoがなぜか「https://prozolic.blog/favicon.ico.br」となっており、一応画像では隠していますが多くのファイルの末尾に **.br** がついていました。
これだと「https://prozolic.blog/favicon.ico」でリクエストしても条件に入らないため、とりあえず`${event.request.url}.br`も条件に加えるはどうかと思い、以下のように修正してみました。

```javascript
async function onFetch(event) {
        ...
        const shouldServeIndexHtml = event.request.mode === 'navigate'
            && !manifestUrlList.some(url => url === event.request.url || url === `${event.request.url}.br`);
        ...
}
```

デプロイ後に再度 https://prozolic.blog/favicon.ico へアクセスしたところ、問題なくアイコンが表示されました。修正方法が最適かはわかりませんが、とりあえず解決したので良しとします！  
※**.br**についてはBlazor WebAssemblyアプリを公開（発行）時に、基本的なファイルはBrotli 圧縮されたファイルが生成されるため、おそらくサービスワーカーのキャッシュに登録される際に **.br** がついてしまっていると思われます。多分。

## まとめ

前半でも書いていますが、アプリに影響を与えるものではないため、普段は気にしないで問題ないと思います。
ただ、デバッグ環境だと問題なく、公開環境で発生する現象だったので、同じような現象に遭遇している方は参考にどうぞです。  
今回はこの辺で、それでは！